# 日志系统使用说明

## 概述

智能对话训练平台已集成完整的日志记录系统，提供实时日志记录、查看和分析功能。

## 日志文件类型

系统会在 `backend/logs/` 目录下自动创建以下日志文件：

### 1. API请求日志 (`api_requests.log`)
- 记录所有API请求和响应
- 包含请求方法、URL、状态码、响应时间、客户端IP等
- 自动按日期轮转，保留30天

### 2. 系统日志 (`system.log`)  
- 记录系统启动、关闭等重要事件
- 记录数据库初始化、配置变更等系统级操作
- 自动按日期轮转，保留30天

### 3. 错误日志 (`errors.log`)
- 记录所有系统错误和异常
- 包含详细的错误堆栈信息
- 自动按日期轮转，保留30天

### 4. 数据库操作日志 (`database.log`)
- 记录数据库的增删改操作
- 包含操作类型、表名、记录ID等详细信息
- 自动按日期轮转，保留30天

### 5. 训练日志 (`training.log`)
- 记录模型训练相关的所有操作
- 包含训练开始、结束、激活模型等操作
- 自动按日期轮转，保留30天

## 日志格式

所有日志都采用统一的格式：

```
[2024-01-01 12:00:00.123] [INFO] [logger_name] 日志消息
{
  "额外数据": "JSON格式",
  "operation": "操作类型",
  "details": "详细信息"
}
```

## API接口

### 获取日志文件列表
```
GET /api/v2/logs/list
```

### 查看日志文件内容
```
GET /api/v2/logs/view/{log_file}?lines=100&from_end=true&search=关键词
```

### 搜索日志内容
```
GET /api/v2/logs/search?keyword=关键词&max_results=100
```

### 获取日志统计信息
```
GET /api/v2/logs/stats
```

## 使用示例

### 1. 查看最近100条API请求日志
```bash
curl "http://localhost:8001/api/v2/logs/view/api_requests.log?lines=100&from_end=true"
```

### 2. 搜索包含"错误"的日志
```bash
curl "http://localhost:8001/api/v2/logs/search?keyword=错误&max_results=50"
```

### 3. 查看系统启动日志
```bash
curl "http://localhost:8001/api/v2/logs/view/system.log?search=启动"
```

## 日志配置

### 调试模式
设置环境变量 `DEBUG=true` 可以记录更详细的请求体和响应体信息：

```bash
export DEBUG=true
```

### 日志级别
- INFO: 一般信息
- WARNING: 警告信息（如4xx状态码）
- ERROR: 错误信息（如5xx状态码、异常）

### 自动轮转
- 日志文件按天轮转（每天午夜0点）
- 保留最近30天的日志文件
- 自动压缩旧日志文件

## 在代码中使用日志

### 1. 导入日志函数
```python
from utils.logger import log_system, log_error, log_database, log_training
```

### 2. 记录系统日志
```python
log_system("系统启动完成", level="info", extra_data={
    "version": "2.0.0",
    "port": 8001
})
```

### 3. 记录错误日志
```python
try:
    # 一些操作
    pass
except Exception as e:
    log_error("操作失败", error=e, extra_data={
        "operation": "某个操作",
        "user_id": user_id
    })
```

### 4. 记录数据库操作
```python
log_database(
    operation="CREATE",
    table="instruction_library",
    record_id=library.id,
    extra_data={
        "library_name": library.name,
        "created_by": "admin"
    }
)
```

### 5. 记录训练日志
```python
log_training(
    message="开始训练模型",
    level="info",
    library_id=library_id,
    version=version_number,
    extra_data={
        "training_params": params,
        "estimated_time": "30分钟"
    }
)
```

## 日志监控建议

### 1. 定期检查错误日志
```bash
# 查看今天的错误日志
curl "http://localhost:8001/api/v2/logs/view/errors.log?lines=100"
```

### 2. 监控API响应时间
```bash
# 搜索响应时间超过5秒的请求
curl "http://localhost:8001/api/v2/logs/search?keyword=5000ms"
```

### 3. 检查系统资源使用
```bash
# 查看系统日志
curl "http://localhost:8001/api/v2/logs/view/system.log?lines=50"
```

## 注意事项

1. 日志文件会自动创建，无需手动创建
2. 在生产环境中，建议定期清理旧日志文件
3. 敏感信息（如密码）不会记录在日志中
4. 可以通过修改 `utils/logger.py` 来自定义日志格式
5. 日志文件使用UTF-8编码，支持中文

## 故障排查

### 1. 日志文件不存在
- 检查 `backend/logs/` 目录是否存在
- 确认应用有写入权限

### 2. 日志记录不完整
- 检查是否有异常导致日志记录中断
- 查看系统错误日志

### 3. 日志文件过大
- 检查日志轮转是否正常工作
- 可以手动删除旧日志文件

通过这个完整的日志系统，您可以实时监控系统运行状态，快速定位问题，并进行系统性能分析。 