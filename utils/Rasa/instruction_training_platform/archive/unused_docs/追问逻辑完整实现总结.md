# åŒå±æ•°æ®è¿½é—®é€»è¾‘å®Œæ•´å®ç°æ€»ç»“

## ğŸ¯ é—®é¢˜å›ç­”

æ‚¨æåˆ°çš„**è¿½é—®è¯æœ¯ã€è¿½é—®å¤±è´¥è¯æœ¯ã€è¿½é—®æ¬¡æ•°**å‚æ•°åœ¨åŒå±æŒ‡ä»¤ä¸­è¡¨ç¤ºç”¨æˆ·è¾“å…¥è¯æ§½æ²¡å¡«å……å®Œæ¯•æ—¶çš„è¿½é—®å¤„ç†ï¼Œæˆ‘å·²ç»å®Œæ•´èå…¥åˆ°RASAç³»ç»Ÿä¸­ã€‚

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. è¿½é—®é€»è¾‘åœ¨RASAä¸­çš„å®ç°

#### æ ¸å¿ƒæœºåˆ¶ï¼šRASA Formsï¼ˆè¡¨å•ï¼‰
- **Forms**ï¼šè‡ªåŠ¨æ”¶é›†å¿…éœ€çš„è¯æ§½
- **Slot Validation**ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥çš„è¯æ§½å€¼
- **Custom Actions**ï¼šå¤„ç†è¿½é—®é€»è¾‘å’Œæ¬¡æ•°æ§åˆ¶
- **Responses**ï¼šå®šä¹‰è¿½é—®è¯æœ¯å’Œå¤±è´¥è¯æœ¯

#### æ•°æ®æµç¨‹
```
ç”¨æˆ·ï¼š"è®¾ç½®ç«åŠ›" â†’ NLUè¯†åˆ«æ„å›¾ â†’ æ¿€æ´»è¡¨å• â†’ æ£€æµ‹ç¼ºå¤±è¯æ§½ â†’ è¿½é—®"è¯·é€‰æ‹©ç«åŠ›ç­‰çº§" â†’ éªŒè¯è¾“å…¥ â†’ å®Œæˆä»»åŠ¡
```

### 2. åŒå±æ•°æ®å­—æ®µæ˜ å°„

| åŒå±Excelå­—æ®µ | RASAå®ç° | ä½œç”¨ |
|-------------|---------|------|
| å…³è”è¯æ§½ | Form.required_slots | å®šä¹‰å¿…éœ€çš„è¯æ§½åˆ—è¡¨ |
| è¿½é—®è¯æœ¯ | utter_ask_{slot} | è¯æ§½ç¼ºå¤±æ—¶çš„è¯¢é—®å“åº” |
| è¿½é—®å¤±è´¥è¯æœ¯ | utter_ask_{slot}_invalid | éªŒè¯å¤±è´¥æ—¶çš„é‡è¯•å“åº” |
| è¿½é—®æ¬¡æ•° | max_attempts | æœ€å¤§å°è¯•æ¬¡æ•°æ§åˆ¶ |
| ç›¸ä¼¼é—®[è¯æ§½] | å®ä½“æ ‡æ³¨ | è‡ªåŠ¨æ£€æµ‹å¿…éœ€è¯æ§½ |

### 3. å…·ä½“å®ç°ç»†èŠ‚

#### A. æ™ºèƒ½è¯æ§½æ£€æµ‹
```python
def _detect_required_slots(self, related_slots: str, similar_questions: List[str]) -> List[str]:
    """æ£€æµ‹æŒ‡ä»¤ä¸­çš„å¿…éœ€è¯æ§½"""
    required_slots = []
    
    # ä»å…³è”è¯æ§½ä¸­æå–
    if related_slots:
        slots_list = [s.strip() for s in related_slots.split(',')]
        required_slots.extend(slots_list)
    
    # ä»ç›¸ä¼¼é—®ä¸­æå–å¸¦æ ‡æ³¨çš„è¯æ§½
    for question in similar_questions:
        slot_patterns = re.findall(r'\[([^\]]+)\]', question)
        for slot_name in slot_patterns:
            if slot_name not in required_slots:
                required_slots.append(slot_name)
    
    return required_slots
```

#### B. è¡¨å•å®šä¹‰ç”Ÿæˆ
```python
def _generate_form_definition(self, instruction: Dict[str, Any]) -> None:
    """ä¸ºæŒ‡ä»¤ç”ŸæˆRASAè¡¨å•å®šä¹‰"""
    if not instruction['required_slots']:
        return
    
    form_name = f"{instruction['intent']}_form"
    
    # æ„å»ºè¡¨å•çš„å¿…éœ€è¯æ§½æ˜ å°„
    required_slots_mapping = {}
    for slot_name in instruction['required_slots']:
        slot_name_en = self._generate_slot_name_en(slot_name)
        required_slots_mapping[slot_name_en] = [
            {
                'type': 'from_entity',
                'entity': f'entity_{slot_name_en}'
            }
        ]
```

#### C. Domainé…ç½®ç”Ÿæˆ
```yaml
# è‡ªåŠ¨ç”Ÿæˆçš„Domainé…ç½®
forms:
  set_firepower_form:
    required_slots:
      - fire_power

responses:
  utter_ask_fire_power:
    - text: "è¯·é€‰æ‹©æ‚¨è¦è®¾ç½®çš„ç«åŠ›ç­‰çº§"  # æ¥è‡ªè¿½é—®è¯æœ¯
  
  utter_ask_fire_power_invalid:
    - text: "è¯·é€‰æ‹©æ­£ç¡®çš„ç«åŠ›ç­‰çº§ï¼šä½ç«ã€ä¸­ç«ã€é«˜ç«ã€è§£å†»æˆ–ä¸­é«˜ç«"  # æ¥è‡ªè¿½é—®å¤±è´¥è¯æœ¯
```

#### D. è¿½é—®æ¬¡æ•°æ§åˆ¶
```python
class ActionAskSlotValidation(Action):
    """å¤„ç†è¯æ§½éªŒè¯å’Œè¿½é—®æ¬¡æ•°æ§åˆ¶"""
    
    def run(self, dispatcher, tracker, domain):
        requested_slot = tracker.get_slot("requested_slot")
        attempt_count = tracker.get_slot(f"{requested_slot}_attempt_count") or 0
        
        # ä½¿ç”¨Excelä¸­é…ç½®çš„è¿½é—®æ¬¡æ•°
        max_attempts = instruction.get('follow_up_times', 3)
        
        if attempt_count >= max_attempts:
            dispatcher.utter_message(
                text=f"å¾ˆæŠ±æ­‰ï¼Œæˆ‘æ— æ³•è·å–åˆ°æ­£ç¡®çš„{requested_slot}ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹å§ã€‚"
            )
            return [
                {"event": "active_loop", "name": None},
                {"event": "slot", "name": "requested_slot", "value": None}
            ]
        
        # å¢åŠ å°è¯•æ¬¡æ•°
        return [
            {"event": "slot", "name": f"{requested_slot}_attempt_count", "value": attempt_count + 1}
        ]
```

## ğŸ­ å®é™…å¯¹è¯ç¤ºä¾‹

### åœºæ™¯1ï¼šå•è¯æ§½è¿½é—®
```
ç”¨æˆ·: "è®¾ç½®ç«åŠ›"
ç³»ç»Ÿ: [NLUè¯†åˆ«intent: set_firepowerï¼Œæ— fire_powerå®ä½“]
ç³»ç»Ÿ: [æ¿€æ´»set_firepower_formï¼Œæ£€æµ‹åˆ°fire_powerè¯æ§½ç¼ºå¤±]
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ‚¨è¦è®¾ç½®çš„ç«åŠ›ç­‰çº§"  # è¿½é—®è¯æœ¯
ç”¨æˆ·: "é«˜ç«"
ç³»ç»Ÿ: [NLUè¯†åˆ«entity: entity_fire_power="é«˜ç«"]
ç³»ç»Ÿ: [éªŒè¯è¯æ§½å€¼æˆåŠŸï¼Œå¡«å……fire_power="é«˜ç«"]
ç³»ç»Ÿ: "ç«åŠ›å·²è®¾ç½®ä¸ºé«˜ç«"  # æ‰§è¡ŒæˆåŠŸè¯æœ¯
```

### åœºæ™¯2ï¼šè¿½é—®å¤±è´¥é‡è¯•
```
ç”¨æˆ·: "è®¾ç½®ç«åŠ›"
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ‚¨è¦è®¾ç½®çš„ç«åŠ›ç­‰çº§"
ç”¨æˆ·: "å¾ˆå¤§çš„ç«"
ç³»ç»Ÿ: [éªŒè¯å¤±è´¥ï¼Œå°è¯•æ¬¡æ•°+1]
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ­£ç¡®çš„ç«åŠ›ç­‰çº§ï¼šä½ç«ã€ä¸­ç«ã€é«˜ç«ã€è§£å†»æˆ–ä¸­é«˜ç«"  # è¿½é—®å¤±è´¥è¯æœ¯
ç”¨æˆ·: "é«˜ç«"
ç³»ç»Ÿ: [éªŒè¯æˆåŠŸ]
ç³»ç»Ÿ: "ç«åŠ›å·²è®¾ç½®ä¸ºé«˜ç«"
```

### åœºæ™¯3ï¼šè¶…è¿‡è¿½é—®æ¬¡æ•°
```
ç”¨æˆ·: "è®¾ç½®ç«åŠ›"
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ‚¨è¦è®¾ç½®çš„ç«åŠ›ç­‰çº§"
ç”¨æˆ·: "å¾ˆå¤§çš„ç«"  # ç¬¬1æ¬¡é”™è¯¯
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ­£ç¡®çš„ç«åŠ›ç­‰çº§ï¼šä½ç«ã€ä¸­ç«ã€é«˜ç«ã€è§£å†»æˆ–ä¸­é«˜ç«"
ç”¨æˆ·: "è¶…çº§ç«"  # ç¬¬2æ¬¡é”™è¯¯
ç³»ç»Ÿ: "è¯·é€‰æ‹©æ­£ç¡®çš„ç«åŠ›ç­‰çº§ï¼šä½ç«ã€ä¸­ç«ã€é«˜ç«ã€è§£å†»æˆ–ä¸­é«˜ç«"
ç”¨æˆ·: "å·¨å¤§ç«"  # ç¬¬3æ¬¡é”™è¯¯ï¼Œè¾¾åˆ°è¿½é—®æ¬¡æ•°é™åˆ¶
ç³»ç»Ÿ: "å¾ˆæŠ±æ­‰ï¼Œæˆ‘æ— æ³•è·å–åˆ°æ­£ç¡®çš„fire_powerä¿¡æ¯ï¼Œè®©æˆ‘ä»¬é‡æ–°å¼€å§‹å§ã€‚"
```

### åœºæ™¯4ï¼šå¤šè¯æ§½è¿½é—®
```
ç”¨æˆ·: "å¸®æˆ‘æŠŠçº¢çƒ§èåœçƒ¹ä¸€ç‚¹"
ç³»ç»Ÿ: [è¯†åˆ«åˆ°dish_name="çº¢çƒ§èåœ"ï¼Œç¼ºå°‘tasteè¯æ§½]
ç³»ç»Ÿ: [æ¿€æ´»è¡¨å•ï¼Œè¿½é—®ç¼ºå¤±çš„å£æ„Ÿè¯æ§½]
ç³»ç»Ÿ: "è¯·å‘Šè¯‰æˆ‘æ‚¨è¦è®¾ç½®çš„å£æ„Ÿ"
ç”¨æˆ·: "å«©ä¸€äº›"
ç³»ç»Ÿ: [è¯†åˆ«åˆ°taste="è„†å«©"]
ç³»ç»Ÿ: "å·²ä¸ºæ‚¨è®¾ç½®å¥½çº¢çƒ§èåœçš„è„†å«©å£æ„Ÿ"
```

## ğŸ“Š ç”Ÿæˆçš„RASAæ–‡ä»¶ç»“æ„

### 1. NLU.yml - å¢å¼ºç‰ˆ
```yaml
# åŸºç¡€æ„å›¾è®­ç»ƒæ•°æ®
- intent: set_firepower
  examples: |
    - è®¾ç½®[ä½ç«](entity_fire_power)
    - è®¾ç½®[ä¸­ç«](entity_fire_power)
    - è®¾ç½®[é«˜ç«](entity_fire_power)

# æ–°å¢ï¼šé€šç”¨è¿½é—®ç›¸å…³æ„å›¾
- intent: affirm
  examples: |
    - æ˜¯çš„
    - å¯¹
    - å¥½çš„

- intent: deny
  examples: |
    - ä¸æ˜¯
    - ä¸å¯¹
    - é‡æ–°æ¥

- intent: inform
  examples: |
    - æˆ‘è¦[ç«åŠ›]
    - é€‰æ‹©[å£æ„Ÿ]
```

### 2. Domain.yml - å¢å¼ºç‰ˆ
```yaml
# æ–°å¢ï¼šè¡¨å•å®šä¹‰
forms:
  set_firepower_form:
    required_slots:
      - fire_power

# æ–°å¢ï¼šè‡ªå®šä¹‰åŠ¨ä½œ
actions:
  - set_firepower_form
  - action_ask_slot_validation
  - action_handle_slot_filling
  - action_validate_form

# æ–°å¢ï¼šè¿½é—®å“åº”
responses:
  utter_ask_fire_power:
    - text: "è¯·é€‰æ‹©æ‚¨è¦è®¾ç½®çš„ç«åŠ›ç­‰çº§"
  
  utter_ask_fire_power_invalid:
    - text: "è¯·é€‰æ‹©æ­£ç¡®çš„ç«åŠ›ç­‰çº§ï¼šä½ç«ã€ä¸­ç«ã€é«˜ç«ã€è§£å†»æˆ–ä¸­é«˜ç«"
```

### 3. Rules.yml - å¢å¼ºç‰ˆ
```yaml
# æ–°å¢ï¼šè¡¨å•æ¿€æ´»è§„åˆ™
- rule: "Activate set_firepower_form"
  steps:
    - intent: set_firepower
    - action: set_firepower_form
    - active_loop: set_firepower_form

# æ–°å¢ï¼šè¡¨å•æäº¤è§„åˆ™
- rule: "Submit set_firepower_form"
  condition:
    - active_loop: set_firepower_form
  steps:
    - action: set_firepower_form
    - active_loop: null
    - slot_was_set:
        - requested_slot: null
    - action: utter_set_firepower
```

### 4. Stories.yml - å¢å¼ºç‰ˆ
```yaml
# æ–°å¢ï¼šè¯æ§½å¡«å……æˆåŠŸæ•…äº‹
- story: "set_firepower slot filling success"
  steps:
    - intent: set_firepower
    - action: set_firepower_form
    - active_loop: set_firepower_form
    - slot_was_set:
        - requested_slot: fire_power
    - intent: inform
    - action: set_firepower_form
    - active_loop: null
    - action: utter_set_firepower

# æ–°å¢ï¼šè¯æ§½å¡«å……ä¸­æ–­æ•…äº‹
- story: "set_firepower slot filling interrupted"
  steps:
    - intent: set_firepower
    - action: set_firepower_form
    - active_loop: set_firepower_form
    - intent: deny
    - action: utter_ask_rephrase
    - action: set_firepower_form
```

### 5. Actions.py - æ–°å¢æ–‡ä»¶
```python
# å®Œæ•´çš„è¿½é—®é€»è¾‘å¤„ç†
class ActionValidateForm(FormValidationAction):
    """éªŒè¯è¡¨å•è¾“å…¥"""
    
    def validate_fire_power(self, slot_value, dispatcher, tracker, domain):
        """éªŒè¯ç«åŠ›è¯æ§½"""
        valid_values = ["ä½ç«", "ä¸­ç«", "é«˜ç«", "è§£å†»", "ä¸­é«˜ç«"]
        
        if slot_value and slot_value in valid_values:
            return {"fire_power": slot_value}
        else:
            dispatcher.utter_message(response="utter_ask_fire_power_invalid")
            return {"fire_power": None}

class ActionAskSlotValidation(Action):
    """å¤„ç†è¯æ§½éªŒè¯å’Œè¿½é—®æ¬¡æ•°æ§åˆ¶"""
    # ... è¿½é—®æ¬¡æ•°æ§åˆ¶é€»è¾‘
```

## ğŸ¯ å…³é”®ä¼˜åŠ¿

### 1. å®Œå…¨è‡ªåŠ¨åŒ–
- ä»åŒå±Excelæ•°æ®è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„RASAè¿½é—®é…ç½®
- æ— éœ€æ‰‹åŠ¨ç¼–å†™è¡¨å•å®šä¹‰å’Œè¿½é—®é€»è¾‘
- æ™ºèƒ½è¯†åˆ«å¿…éœ€è¯æ§½å’Œç”ŸæˆéªŒè¯è§„åˆ™

### 2. é«˜åº¦å¯é…ç½®
- æ”¯æŒè‡ªå®šä¹‰è¿½é—®è¯æœ¯å’Œå¤±è´¥è¯æœ¯
- å¯é…ç½®æœ€å¤§è¿½é—®æ¬¡æ•°
- æ”¯æŒä¸ªæ€§åŒ–é”™è¯¯å¤„ç†

### 3. å¥å£®çš„é”™è¯¯å¤„ç†
- è¿½é—®æ¬¡æ•°é™åˆ¶é¿å…æ­»å¾ªç¯
- ä¼˜é›…çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
- æ”¯æŒä¸­é€”é€€å‡ºå’Œé‡æ–°å¼€å§‹

### 4. å®Œæ•´çš„å¯¹è¯ç®¡ç†
- ç”Ÿæˆå®Œæ•´çš„Storieså’ŒRulesé…ç½®
- æ”¯æŒå¤æ‚çš„å¤šè½®å¯¹è¯åœºæ™¯
- è‡ªåŠ¨å¤„ç†è¡¨å•æ¿€æ´»å’Œæäº¤

## ğŸ“ˆ æµ‹è¯•éªŒè¯ç»“æœ

é€šè¿‡æµ‹è¯•éªŒè¯ï¼Œè¿½é—®é€»è¾‘åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼š
```
âœ… æ£€æµ‹åˆ°å¿…éœ€è¯æ§½: ['ç«åŠ›', 'èœå“åç§°']
âœ… ç”Ÿæˆè¡¨å•å®šä¹‰: 1 ä¸ª
ğŸ“‹ è¡¨å•ä¿¡æ¯:
   åç§°: set_firepower_form
   æ„å›¾: set_firepower
   è¿½é—®æ¬¡æ•°: 3
ğŸ‰ è¿½é—®é€»è¾‘æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ“ æ€»ç»“

åŒå±æ•°æ®å¤„ç†å™¨ç°åœ¨å®Œå…¨æ”¯æŒè¿½é—®é€»è¾‘ï¼Œå®ç°äº†ï¼š

1. **æ™ºèƒ½è¯æ§½æ£€æµ‹**ï¼šè‡ªåŠ¨ä»å…³è”è¯æ§½å’Œç›¸ä¼¼é—®æ ‡æ³¨ä¸­è¯†åˆ«å¿…éœ€è¯æ§½
2. **è¡¨å•è‡ªåŠ¨ç”Ÿæˆ**ï¼šä¸ºæ¯ä¸ªéœ€è¦è¯æ§½å¡«å……çš„æŒ‡ä»¤ç”ŸæˆRASAè¡¨å•å®šä¹‰
3. **è¿½é—®è¯æœ¯æ˜ å°„**ï¼šå°†Excelä¸­çš„è¿½é—®è¯æœ¯è½¬æ¢ä¸ºRASAå“åº”æ¨¡æ¿
4. **éªŒè¯æœºåˆ¶**ï¼šå®Œæ•´çš„è¯æ§½éªŒè¯å’Œé”™è¯¯å¤„ç†é€»è¾‘
5. **æ¬¡æ•°æ§åˆ¶**ï¼šæ”¯æŒè‡ªå®šä¹‰æœ€å¤§è¿½é—®æ¬¡æ•°ï¼Œé¿å…æ­»å¾ªç¯
6. **å¯¹è¯ç®¡ç†**ï¼šç”Ÿæˆå®Œæ•´çš„Ruleså’ŒStoriesé…ç½®

è¿™ç¡®ä¿äº†å½“ç”¨æˆ·è¾“å…¥çš„æŒ‡ä»¤ä¸­è¯æ§½æ²¡æœ‰å¡«å……å®Œæ¯•æ—¶ï¼Œç³»ç»Ÿèƒ½å¤Ÿï¼š
- æ™ºèƒ½æ£€æµ‹ç¼ºå¤±çš„è¯æ§½
- ä½¿ç”¨åˆé€‚çš„è¯æœ¯è¿›è¡Œè¿½é—®
- éªŒè¯ç”¨æˆ·çš„å›ç­”
- åœ¨å¤šæ¬¡å¤±è´¥åä¼˜é›…é€€å‡º
- å®Œæˆæ‰€æœ‰è¯æ§½å¡«å……åæ‰§è¡ŒæŒ‡ä»¤

**è¿½é—®é€»è¾‘å·²ç»å®Œå…¨èå…¥åˆ°RASAæ¡†æ¶ä¸­ï¼Œå®ç°äº†ä»åŒå±æ•°æ®åˆ°æ™ºèƒ½å¯¹è¯çš„å®Œæ•´è½¬æ¢ã€‚**

---

*å®Œæˆæ—¶é—´: 2025-07-01* 