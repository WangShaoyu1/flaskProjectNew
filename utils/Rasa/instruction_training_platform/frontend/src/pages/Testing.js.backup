import React, { useState, useEffect, useRef } from 'react';
import { 
  Card, 
  Input, 
  Button, 
  Typography, 
  Space, 
  Divider,
  Upload,
  Table,
  Progress,
  Alert,
  message,
  Tabs,
  Form,
  Row,
  Col,
  Modal,
  InputNumber,
  Collapse,
  Tag,
  List,
  Spin,
  Select,
  Slider,
  Switch,
  Dropdown
} from 'antd';

import { 
  SendOutlined, 
  UploadOutlined, 
  ApiOutlined,
  FileTextOutlined,
  BarChartOutlined,
  SettingOutlined,
  DownloadOutlined,
  UserOutlined,
  RobotOutlined,
  ExpandAltOutlined,
  CompressOutlined,
  CodeOutlined,
  EyeOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  QuestionCircleOutlined,
  ClockCircleOutlined,
  ThunderboltOutlined,
  ExperimentOutlined
} from '@ant-design/icons';

import { rasaAPI, toolsAPI } from '../api';
import CustomLoading from '../components/CustomLoading';

const { TextArea } = Input;
const { Title, Text, Paragraph } = Typography;
const { Option } = Select;

const Testing = () => {
  const [testText, setTestText] = useState('');
  const [testHistory, setTestHistory] = useState([]);
  const [latestRawResponse, setLatestRawResponse] = useState(null);
  const [testing, setTesting] = useState(false);
  
  // èŠå¤©å†å²å®¹å™¨çš„å¼•ç”¨ï¼Œç”¨äºè‡ªåŠ¨æ»šåŠ¨
  const chatHistoryRef = useRef(null);
  
  // æ¨¡å‹å’Œé…ç½®ç›¸å…³çŠ¶æ€
  const [availableModels, setAvailableModels] = useState([]);
  const [selectedModel, setSelectedModel] = useState(null);
  const [globalConfig, setGlobalConfig] = useState({
    confidenceThreshold: 0.8, // å…¨å±€ç½®ä¿¡åº¦é˜ˆå€¼
    showAdvanced: false // æ˜¯å¦æ˜¾ç¤ºé«˜çº§è®¾ç½®
  });
  const [configModalVisible, setConfigModalVisible] = useState(false);
  
  // åŸå§‹å“åº”å¼¹æ¡†çŠ¶æ€
  const [rawResponseModalVisible, setRawResponseModalVisible] = useState(false);
  const [currentRawResponse, setCurrentRawResponse] = useState(null);
  
  // æ‰¹é‡æµ‹è¯•ç›¸å…³çŠ¶æ€
  const [batchModalVisible, setBatchModalVisible] = useState(false);
  const [batchTestData, setBatchTestData] = useState([]);
  const [batchTestResult, setBatchTestResult] = useState(null);
  const [batchTesting, setBatchTesting] = useState(false);
  const [batchTestConfig, setBatchTestConfig] = useState({
    confidence_threshold: 0.8 // ä½¿ç”¨å…¨å±€é…ç½®çš„ç½®ä¿¡åº¦é˜ˆå€¼
  });
  
  // æ‰¹é‡æµ‹è¯•ç»“æœåˆ†é¡µçŠ¶æ€
  const [batchPagination, setBatchPagination] = useState({
    current: 1,
    pageSize: 20
  });
  
  // è¯¦æƒ…å¼¹çª—çŠ¶æ€
  const [detailModalVisible, setDetailModalVisible] = useState(false);
  const [detailType, setDetailType] = useState(''); // 'recognized' æˆ– 'unrecognized'
  const [detailData, setDetailData] = useState([]);

  // åŠ è½½å¯ç”¨æ¨¡å‹
  useEffect(() => {
    loadAvailableModels();
  }, []);

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ - å½“æµ‹è¯•å†å²æ›´æ–°æ—¶
  useEffect(() => {
    if (chatHistoryRef.current && testHistory.length > 0) {
      // ä½¿ç”¨ setTimeout ç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ»šåŠ¨
      setTimeout(() => {
        const container = chatHistoryRef.current;
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
  }, [testHistory]);

  const loadAvailableModels = async () => {
    try {
      const response = await toolsAPI.getModels();
      const models = response.data || [];
      setAvailableModels(models);
      
      // è‡ªåŠ¨é€‰æ‹©æ¿€æ´»çš„æ¨¡å‹
      const activeModel = models.find(model => model.is_active);
      if (activeModel) {
        setSelectedModel(activeModel);
      } else if (models.length > 0) {
        setSelectedModel(models[0]);
      }
    } catch (error) {
      console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
      message.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
    }
  };

  // å•æ¡æµ‹è¯• - å¯¹è¯å¼
  const handleSingleTest = async () => {
    if (!testText.trim()) {
      message.warning('è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬');
      return;
    }

    if (!selectedModel) {
      message.warning('è¯·å…ˆé€‰æ‹©æµ‹è¯•æ¨¡å‹');
      return;
    }

    setTesting(true);
    const startTime = Date.now(); // è®°å½•å¼€å§‹æ—¶é—´
    
    try {
      const response = await rasaAPI.predict(testText);
      const endTime = Date.now(); // è®°å½•ç»“æŸæ—¶é—´
      const responseTime = endTime - startTime; // è®¡ç®—å“åº”æ—¶é—´
      const result = response.data;
      
      // æ˜¾ç¤ºå“åº”æ—¶é—´æé†’
      if (responseTime > 3000) {
        message.warning(`å“åº”æ—¶é—´è¾ƒé•¿: ${responseTime}msï¼Œå»ºè®®æ£€æŸ¥æ¨¡å‹æ€§èƒ½`);
      } else if (responseTime > 1000) {
        message.info(`å“åº”æ—¶é—´: ${responseTime}ms`);
      } else {
        message.success(`å“åº”æ—¶é—´: ${responseTime}ms`);
      }
      
      // æ·»åŠ åˆ°å¯¹è¯å†å²
      const newMessage = {
        id: Date.now(),
        type: 'user',
        content: testText,
        timestamp: new Date(),
        responseTime: responseTime
      };
      
      // ä½¿ç”¨å…¨å±€é˜ˆå€¼åˆ¤æ–­æ„å›¾è¯†åˆ«çŠ¶æ€ - ä¿®å¤æ•°æ®æå–é€»è¾‘
      const intentName = result.intent?.name || result.intent;
      const intentConfidence = result.intent?.confidence || result.confidence || 0;
      
      // å…³é”®è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” æ„å›¾è¯†åˆ«è°ƒè¯•:');
      console.log('ğŸ“Š APIå“åº”:', result);
      console.log('ğŸ¯ æ„å›¾åç§°:', intentName, 'ç±»å‹:', typeof intentName);
      console.log('ğŸ“ˆ ç½®ä¿¡åº¦:', intentConfidence, 'ç±»å‹:', typeof intentConfidence);
      console.log('âš–ï¸ é˜ˆå€¼:', globalConfig.confidenceThreshold, 'ç±»å‹:', typeof globalConfig.confidenceThreshold);
      console.log('ğŸ”¢ ç½®ä¿¡åº¦æ¯”è¾ƒ:', intentConfidence, '>=', globalConfig.confidenceThreshold, '=', intentConfidence >= globalConfig.confidenceThreshold);
      
      const isRecognized = intentName && 
                          intentName !== 'nlu_fallback' && 
                          intentName !== 'out_of_scope' && 
                          intentName.trim() !== '' &&
                          intentConfidence >= globalConfig.confidenceThreshold; // ä½¿ç”¨å…¨å±€é˜ˆå€¼
      
      console.log('âœ… æœ€ç»ˆè¯†åˆ«ç»“æœ:', isRecognized);
      console.log('========================');
      
      const botResponse = {
        id: Date.now() + 1,
        type: 'bot',
        content: {
          text: testText,
          intent: intentName, // å§‹ç»ˆæ˜¾ç¤ºå®é™…çš„æ„å›¾åç§°
          confidence: intentConfidence,
          entities: result.entities || [],
          raw: result,
          responseTime: responseTime,
          isRecognized: isRecognized,
          modelInfo: selectedModel // æ·»åŠ æ¨¡å‹ä¿¡æ¯
        },
        timestamp: new Date()
      };

      setTestHistory(prev => [...prev, newMessage, botResponse]);
      setLatestRawResponse(result);
      setTestText(''); // æ¸…ç©ºè¾“å…¥æ¡†
    } catch (error) {
      const endTime = Date.now();
      const responseTime = endTime - startTime;
      message.error(`æµ‹è¯•å¤±è´¥ (è€—æ—¶: ${responseTime}ms)`);
      console.error('æµ‹è¯•å¤±è´¥:', error);
    } finally {
      setTesting(false);
    }
  };

  // æ¸…ç©ºå¯¹è¯å†å²
  const clearHistory = () => {
    setTestHistory([]);
    setLatestRawResponse(null);
  };

  // æ˜¾ç¤ºåŸå§‹å“åº”
  const showRawResponse = (rawData) => {
    setCurrentRawResponse(rawData);
    setRawResponseModalVisible(true);
  };

  // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
  const showDetailModal = (type, results) => {
    let filteredData = [];
    
    if (type === 'recognized') {
      // è¿‡æ»¤å‡ºæˆåŠŸè¯†åˆ«çš„æ•°æ®
      filteredData = results.filter(item => 
        item.predicted_intent && 
        item.predicted_intent !== 'nlu_fallback' && 
        item.predicted_intent !== 'out_of_scope' &&
        item.confidence >= globalConfig.confidenceThreshold
      );
    } else if (type === 'unrecognized') {
      // è¿‡æ»¤å‡ºæœªè¯†åˆ«çš„æ•°æ®
      filteredData = results.filter(item => 
        !item.predicted_intent || 
        item.predicted_intent === 'nlu_fallback' || 
        item.predicted_intent === 'out_of_scope' ||
        item.confidence < globalConfig.confidenceThreshold
      );
    }
    
    setDetailType(type);
    setDetailData(filteredData);
    setDetailModalVisible(true);
  };

  // æ‰¹é‡æµ‹è¯•é…ç½®å¼¹çª—
  const showBatchTestModal = () => {
    setBatchModalVisible(true);
  };

  // æ‰¹é‡æµ‹è¯• - ç®€åŒ–ç‰ˆ
  const handleBatchTest = async () => {
    if (batchTestData.length === 0) {
      message.warning('è¯·å…ˆä¸Šä¼ æµ‹è¯•æ•°æ®');
      return;
    }

    setBatchTesting(true);
    try {
      const response = await toolsAPI.batchTest({
        test_data: batchTestData,
        confidence_threshold: globalConfig.confidenceThreshold // ä½¿ç”¨å…¨å±€é…ç½®çš„é˜ˆå€¼
      });
      setBatchTestResult(response.data);
      message.success(`æ‰¹é‡æµ‹è¯•å®Œæˆï¼å…±æµ‹è¯• ${batchTestData.length} æ¡æ•°æ®`);
      setBatchModalVisible(false);
    } catch (error) {
      message.error('æ‰¹é‡æµ‹è¯•å¤±è´¥');
      console.error('æ‰¹é‡æµ‹è¯•å¤±è´¥:', error);
    } finally {
      setBatchTesting(false);
    }
  };

  // å¤„ç†æ–‡ä»¶ä¸Šä¼  - ç®€åŒ–ç‰ˆï¼Œç›´æ¥ä¸Šä¼ åˆ°åç«¯å¤„ç†
  const handleFileUpload = async (file) => {
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    const allowedTypes = ['.xlsx', '.xls', '.csv', '.txt', '.json'];
    const fileName = file.name.toLowerCase();
    const isValidType = allowedTypes.some(type => fileName.endsWith(type));
    
    if (!isValidType) {
      message.error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·ä¸Šä¼  Excel(.xlsx/.xls)ã€CSV(.csv)ã€æ–‡æœ¬(.txt) æˆ– JSON(.json) æ–‡ä»¶');
      return false;
    }

    // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (file.size > maxSize) {
      message.error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
      return false;
    }

    try {
      message.loading('æ­£åœ¨ä¸Šä¼ å’Œè§£ææ–‡ä»¶...', 0);
      
      // åˆ›å»ºFormDataå¯¹è±¡
      const formData = new FormData();
      formData.append('file', file);
      
      // è°ƒç”¨åç«¯æ¥å£ä¸Šä¼ æ–‡ä»¶
      const response = await toolsAPI.uploadBatchTestFile(formData);
      
      message.destroy(); // å…³é—­loading
      
      if (response.data && response.data.test_data) {
        setBatchTestData(response.data.test_data);
        message.success(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼è§£æåˆ° ${response.data.test_data.length} æ¡æµ‹è¯•æ•°æ®`);
      } else {
        message.warning('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°æœ‰æ•ˆçš„æµ‹è¯•æ•°æ®');
      }
      
    } catch (error) {
      message.destroy(); // å…³é—­loading
      console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error);
      
      if (error.response && error.response.data && error.response.data.detail) {
        message.error(`æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.response.data.detail}`);
      } else {
        message.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œç½‘ç»œè¿æ¥');
      }
    }
    
    return false; // é˜»æ­¢Antdçš„é»˜è®¤ä¸Šä¼ è¡Œä¸º
  };

  // ä¸‹è½½æµ‹è¯•æ¨¡æ¿ - æ”¯æŒå¤šç§æ ¼å¼
  const downloadTemplate = (format = 'csv') => {
    const testData = [
      'æŸ¥è¯¢åŒ—äº¬å¤©æ°”',
      'é¢„è®¢æœºç¥¨åˆ°ä¸Šæµ·',
      'è°ƒæ•´å±å¹•äº®åº¦',
      'æ’­æ”¾éŸ³ä¹',
      'å…³é—­å®¢å…ç¯å…‰',
      'è®¾ç½®æ˜å¤©æ—©ä¸Š7ç‚¹é—¹é’Ÿ',
      'æŸ¥è¯¢å½“å‰æ—¶é—´',
      'æ‰“å¼€ç©ºè°ƒåˆ¶å†·æ¨¡å¼',
      'åˆ‡æ¢åˆ°CCTV1é¢‘é“'
    ];

    let content, filename, mimeType;

    switch (format) {
      case 'csv':
        content = 'æµ‹è¯•æ–‡æœ¬\n' + testData.join('\n');
        filename = 'æ‰¹é‡æµ‹è¯•æ¨¡æ¿.csv';
        mimeType = 'text/csv;charset=utf-8';
        break;
      
      case 'txt':
        content = testData.join('\n');
        filename = 'æ‰¹é‡æµ‹è¯•æ¨¡æ¿.txt';
        mimeType = 'text/plain;charset=utf-8';
        break;
      
      case 'json':
        content = JSON.stringify(testData, null, 2);
        filename = 'æ‰¹é‡æµ‹è¯•æ¨¡æ¿.json';
        mimeType = 'application/json;charset=utf-8';
        break;
      
      default:
        content = 'æµ‹è¯•æ–‡æœ¬\n' + testData.join('\n');
        filename = 'æ‰¹é‡æµ‹è¯•æ¨¡æ¿.csv';
        mimeType = 'text/csv;charset=utf-8';
    }

    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    
    message.success(`å·²ä¸‹è½½ ${format.toUpperCase()} æ ¼å¼æ¨¡æ¿æ–‡ä»¶`);
  };

  // æ¸²æŸ“é«˜äº®æ–‡æœ¬ï¼ˆçªå‡ºæ˜¾ç¤ºå®ä½“ï¼‰
  const renderHighlightedText = (text, entities) => {
    if (!entities || entities.length === 0) {
      return text;
    }

    // æŒ‰èµ·å§‹ä½ç½®æ’åºå®ä½“
    const sortedEntities = [...entities]
      .filter(entity => entity.start !== undefined && entity.end !== undefined)
      .sort((a, b) => a.start - b.start);

    if (sortedEntities.length === 0) {
      return text;
    }

    const result = [];
    let lastIndex = 0;

    sortedEntities.forEach((entity, index) => {
      // æ·»åŠ å®ä½“å‰çš„æ–‡æœ¬
      if (entity.start > lastIndex) {
        result.push(text.substring(lastIndex, entity.start));
      }

      // æ·»åŠ é«˜äº®çš„å®ä½“
      const entityText = text.substring(entity.start, entity.end);
      const confidence = entity.confidence || entity.confidence_entity || 1;
      const confidencePercent = Math.round(confidence * 100);
      
      result.push(
        <span
          key={`entity-${index}`}
          style={{
            backgroundColor: confidencePercent > 80 ? '#e6f7ff' : 
                           confidencePercent > 60 ? '#fff2e6' : '#fff1f0',
            color: confidencePercent > 80 ? '#1890ff' : 
                   confidencePercent > 60 ? '#fa8c16' : '#ff4d4f',
            padding: '1px 3px',
            borderRadius: 2,
            fontWeight: 600,
            border: `1px solid ${
              confidencePercent > 80 ? '#91d5ff' : 
              confidencePercent > 60 ? '#ffd591' : '#ffccc7'
            }`,
            cursor: 'help'
          }}
          title={`${entity.entity}: ${entity.value} (${confidencePercent}%)`}
        >
          {entityText}
        </span>
      );

      lastIndex = entity.end;
    });

    // æ·»åŠ æœ€åå‰©ä½™çš„æ–‡æœ¬
    if (lastIndex < text.length) {
      result.push(text.substring(lastIndex));
    }

    return result;
  };

  // æ¸²æŸ“æ¶ˆæ¯
  const renderMessage = (message) => {
    if (message.type === 'user') {
      return (
        <div key={message.id} style={{ marginBottom: 12, textAlign: 'right', position: 'relative' }}>
          {/* æ—¶é—´æˆ³ - å³ä¸Šè§’ï¼Œæ ¼å¼ï¼šå¹´æœˆæ—¥ æ—¶åˆ†ç§’ */}
          <div style={{ 
            position: 'absolute',
            top: -18,
            right: 0,
            fontSize: 11, 
            color: '#999'
          }}>
            {message.timestamp.toLocaleString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            })}
          </div>
          <div style={{ 
            display: 'inline-block', 
            maxWidth: '70%', 
            padding: '8px 12px',
            backgroundColor: '#1890ff',
            color: 'white',
            borderRadius: '16px 16px 4px 16px',
            wordBreak: 'break-word'
          }}>
            <UserOutlined style={{ marginRight: 6 }} />
            {message.content}
          </div>
        </div>
      );
    } else {
      // Botæ¶ˆæ¯ - ä¿®å¤æ—¶é—´æˆ³ä½ç½®åˆ°å›å¤æ¡†å†…éƒ¨å³ä¸Šè§’
      const { content } = message;
      return (
        <div key={message.id} style={{ marginBottom: 12, textAlign: 'left' }}>
          <div style={{ 
            display: 'inline-block', 
            maxWidth: '85%', 
            padding: '10px 14px',
            backgroundColor: '#f5f5f5',
            borderRadius: '16px 16px 16px 4px',
            wordBreak: 'break-word',
            position: 'relative' // æ·»åŠ ç›¸å¯¹å®šä½ï¼Œç”¨äºæ—¶é—´æˆ³çš„ç»å¯¹å®šä½
          }}>
            {/* æ—¶é—´æˆ³ - ç§»åˆ°å›å¤æ¡†å†…éƒ¨å³ä¸Šè§’ */}
            <div style={{ 
              position: 'absolute',
              top: 8,
              right: 12,
              fontSize: 10, 
              color: '#999',
              backgroundColor: 'rgba(255, 255, 255, 0.8)',
              padding: '2px 6px',
              borderRadius: 4,
              zIndex: 1
            }}>
              {message.timestamp.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
              })}
            </div>
            
            {/* æœºå™¨äººå›¾æ ‡å’Œæµ‹è¯•æ–‡æœ¬ */}
            <div style={{ marginBottom: 8, paddingRight: 80 }}> {/* æ·»åŠ å³ä¾§paddingä¸ºæ—¶é—´æˆ³ç•™ç©ºé—´ */}
              <RobotOutlined style={{ 
                color: '#1890ff', 
                marginRight: 6, 
                fontSize: 14 
              }} />
              <span style={{ fontWeight: 500 }}>
                {renderHighlightedText(content.text, content.entities)}
              </span>
            </div>
            
            {/* è¯†åˆ«çŠ¶æ€ã€å®ä½“ã€å“åº”æ—¶é—´ä¸€è¡Œæ˜¾ç¤º */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              flexWrap: 'wrap',
              gap: '8px',
              padding: '6px 0',
              borderTop: '1px solid #e8e8e8'
            }}>
              {/* è¯†åˆ«çŠ¶æ€ - ä¿®å¤ç½®ä¿¡åº¦åˆ¤æ–­é€»è¾‘ */}
              <div style={{ display: 'flex', alignItems: 'center' }}>
                {content.isRecognized ? (
                  <CheckCircleOutlined style={{ color: '#52c41a', marginRight: 4 }} />
                ) : (
                  <CloseCircleOutlined style={{ color: '#ff4d4f', marginRight: 4 }} />
                )}
                <Tag 
                  color={content.isRecognized ? 'success' : 'error'}
                  style={{ margin: 0, fontSize: 11 }}
                >
                  {content.isRecognized ? content.intent : 'æœªè¯†åˆ«'}
                </Tag>
                <span style={{ 
                  color: '#666', 
                  fontSize: 11, 
                  marginLeft: 4 
                }}>
                  {Math.round(content.confidence * 100)}%
                </span>
              </div>

              <Divider type="vertical" style={{ margin: 0, height: 14 }} />

              {/* å®ä½“æƒ…å†µ */}
              <div style={{ display: 'flex', alignItems: 'center' }}>
                {content.entities && content.entities.length > 0 ? (
                  <>
                    <EyeOutlined style={{ color: '#1890ff', marginRight: 4 }} />
                    <span style={{ fontSize: 11, color: '#666' }}>
                      {content.entities.length}ä¸ªå®ä½“
                    </span>
                  </>
                ) : (
                  <>
                    <QuestionCircleOutlined style={{ color: '#d9d9d9', marginRight: 4 }} />
                    <span style={{ fontSize: 11, color: '#999' }}>æ— å®ä½“</span>
                  </>
                )}
              </div>

              <Divider type="vertical" style={{ margin: 0, height: 14 }} />

              {/* å“åº”æ—¶é—´ */}
              <div style={{ display: 'flex', alignItems: 'center' }}>
                <ClockCircleOutlined style={{ 
                  color: content.responseTime > 3000 ? '#ff4d4f' : 
                         content.responseTime > 1000 ? '#fa8c16' : '#52c41a',
                  marginRight: 4 
                }} />
                <span style={{ 
                  fontSize: 11, 
                  color: content.responseTime > 3000 ? '#ff4d4f' : 
                         content.responseTime > 1000 ? '#fa8c16' : '#52c41a'
                }}>
                  {content.responseTime}ms
                </span>
              </div>

              <Divider type="vertical" style={{ margin: 0, height: 14 }} />

              {/* åŸå§‹å“åº”æŒ‰é’® */}
              <Button
                type="text"
                size="small"
                icon={<CodeOutlined />}
                onClick={() => showRawResponse(content.raw)}
                style={{
                  padding: '0 4px',
                  height: 18,
                  fontSize: 11,
                  color: '#666'
                }}
              >
                åŸå§‹å“åº”
              </Button>
            </div>

            {/* å®ä½“è¯¦æƒ…å±•ç¤º */}
            {content.entities && content.entities.length > 0 && (
              <Collapse
                ghost
                size="small"
                style={{ marginTop: 8 }}
                items={[{
                  key: 'entities',
                  label: (
                    <span style={{ fontSize: 11, color: '#666' }}>
                      <EyeOutlined style={{ marginRight: 4 }} />
                      å®ä½“è¯¦æƒ… ({content.entities.length})
                    </span>
                  ),
                  children: (
                    <div style={{ paddingLeft: 8 }}>
                      {content.entities.map((entity, index) => {
                        const confidence = entity.confidence || entity.confidence_entity || 1;
                        const confidencePercent = Math.round(confidence * 100);
                        return (
                          <Tag
                            key={index}
                            style={{
                              marginBottom: 4,
                              padding: '2px 8px',
                              fontSize: 11,
                              borderRadius: 4
                            }}
                            color={confidencePercent > 80 ? 'blue' : 
                                   confidencePercent > 60 ? 'orange' : 'red'}
                          >
                            <strong>{entity.entity}:</strong> {entity.value} 
                            <span style={{ opacity: 0.8 }}>
                              ({confidencePercent}%)
                            </span>
                          </Tag>
                        );
                      })}
                    </div>
                  )
                }]}
              />
            )}
          </div>
        </div>
      );
    }
  };

  // æ¸²æŸ“æ‰¹é‡æµ‹è¯•ç»“æœ - ç®€åŒ–ç‰ˆï¼Œåªæ˜¾ç¤ºæ„å›¾è¯†åˆ«ç»“æœ
  const renderBatchTestResult = () => {
    if (!batchTestResult) {
      return (
        <div style={{ 
          flex: 1,
          display: 'flex',
          alignItems: 'center', 
          justifyContent: 'center',
          height: '100%',
          textAlign: 'center',
          color: '#999' 
        }}>
          <div>
            <BarChartOutlined style={{ fontSize: 64, marginBottom: 24, color: '#d9d9d9' }} />
            <div style={{ fontSize: 18, marginBottom: 8 }}>æš‚æ— æµ‹è¯•ç»“æœ</div>
            <div style={{ fontSize: 14 }}>
              ç‚¹å‡»"å¼€å§‹æ‰¹é‡æµ‹è¯•"ä¸Šä¼ æ–‡ä»¶å¹¶è¿›è¡Œæµ‹è¯•
            </div>
          </div>
        </div>
      );
    }

    const { total_tests, results } = batchTestResult;
    
    // ç»Ÿè®¡è¯†åˆ«ç»“æœ
    const recognizedCount = results.filter(item => 
      item.predicted_intent && 
      item.predicted_intent !== 'nlu_fallback' && 
      item.predicted_intent !== 'out_of_scope' &&
      item.confidence >= globalConfig.confidenceThreshold
    ).length;
    
          const unrecognizedCount = total_tests - recognizedCount;
      const recognitionRate = total_tests > 0 ? Math.round((recognizedCount / total_tests) * 100) : 0;

    const resultColumns = [
      {
        title: 'åºå·',
        key: 'index',
        width: 60,
        render: (text, record, index) => {
          // è®¡ç®—çœŸå®åºå·ï¼š(å½“å‰é¡µç -1) * æ¯é¡µæ¡æ•° + å½“å‰è¡Œç´¢å¼• + 1
          return (batchPagination.current - 1) * batchPagination.pageSize + index + 1;
        },
      },
      {
        title: 'æµ‹è¯•æ–‡æœ¬',
        dataIndex: 'text',
        key: 'text',
        ellipsis: true,
        width: '40%',
      },
      {
        title: 'è¯†åˆ«æ„å›¾',
        dataIndex: 'predicted_intent',
        key: 'predicted_intent',
        width: '25%',
        render: (text, record) => {
          const isRecognized = text && 
                               text !== 'nlu_fallback' && 
                               text !== 'out_of_scope' &&
                               record.confidence >= globalConfig.confidenceThreshold;
          
          return (
            <Tag color={isRecognized ? 'success' : 'error'}>
              {isRecognized ? text : 'æœªè¯†åˆ«'}
            </Tag>
          );
        }
      },
      {
        title: 'ç½®ä¿¡åº¦',
        dataIndex: 'confidence',
        key: 'confidence',
        width: '20%',
        render: (confidence) => {
          const percent = Math.round((confidence || 0) * 100);
          return (
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <Progress 
                percent={percent} 
                size="small"
                status={confidence >= globalConfig.confidenceThreshold ? 'success' : 'exception'}
                style={{ flex: 1 }}
              />
              <span style={{ 
                fontSize: 12, 
                color: confidence >= globalConfig.confidenceThreshold ? '#52c41a' : '#ff4d4f',
                fontWeight: 500 
              }}>
                {percent}%
              </span>
            </div>
          );
        }
      },
      {
        title: 'çŠ¶æ€',
        key: 'status',
        width: '15%',
        render: (text, record) => {
          const isRecognized = record.predicted_intent && 
                               record.predicted_intent !== 'nlu_fallback' && 
                               record.predicted_intent !== 'out_of_scope' &&
                               record.confidence >= globalConfig.confidenceThreshold;
          
          return (
            <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
              {isRecognized ? (
                <CheckCircleOutlined style={{ color: '#52c41a' }} />
              ) : (
                <CloseCircleOutlined style={{ color: '#ff4d4f' }} />
              )}
              <span style={{ 
                fontSize: 12,
                color: isRecognized ? '#52c41a' : '#ff4d4f',
                fontWeight: 500
              }}>
                {isRecognized ? 'å·²è¯†åˆ«' : 'æœªè¯†åˆ«'}
              </span>
            </div>
          );
        }
      }
    ];

    return (
      <Card 
        title="æ‰¹é‡æµ‹è¯•ç»“æœ" 
        style={{ 
          marginTop: 24, 
          height: '100%',
          display: 'flex',
          flexDirection: 'column'
        }}
        bodyStyle={{
          flex: 1,
          display: 'flex',
          flexDirection: 'column',
          padding: '24px'
        }}
      >
        <Row gutter={16} style={{ marginBottom: 16 }}>
          <Col span={6}>
            <Card size="small">
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 24, fontWeight: 'bold', color: '#1890ff' }}>
                  {total_tests}
                </div>
                <div>æ€»æµ‹è¯•æ•°</div>
              </div>
            </Card>
          </Col>
          <Col span={6}>
            <Card 
              size="small" 
              hoverable
              onClick={() => showDetailModal('recognized', results)}
              style={{ 
                cursor: 'pointer',
                transition: 'all 0.3s ease',
                border: '1px solid #d9d9d9'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.borderColor = '#52c41a';
                e.currentTarget.style.boxShadow = '0 4px 12px rgba(82, 196, 26, 0.15)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.borderColor = '#d9d9d9';
                e.currentTarget.style.boxShadow = 'none';
              }}
            >
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 24, fontWeight: 'bold', color: '#52c41a' }}>
                  {recognizedCount}
                </div>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>
                  <span>æˆåŠŸè¯†åˆ«</span>
                  <EyeOutlined style={{ fontSize: 12, color: '#52c41a' }} />
                </div>
              </div>
            </Card>
          </Col>
          <Col span={6}>
            <Card size="small">
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 24, fontWeight: 'bold', color: '#fa8c16' }}>
                  {recognitionRate}%
                </div>
                <div>è¯†åˆ«ç‡</div>
              </div>
            </Card>
          </Col>
          <Col span={6}>
            <Card 
              size="small" 
              hoverable
              onClick={() => showDetailModal('unrecognized', results)}
              style={{ 
                cursor: 'pointer',
                transition: 'all 0.3s ease',
                border: '1px solid #d9d9d9'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.borderColor = '#ff4d4f';
                e.currentTarget.style.boxShadow = '0 4px 12px rgba(255, 77, 79, 0.15)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.borderColor = '#d9d9d9';
                e.currentTarget.style.boxShadow = 'none';
              }}
            >
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: 24, fontWeight: 'bold', color: '#ff4d4f' }}>
                  {unrecognizedCount}
                </div>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>
                  <span>æœªè¯†åˆ«</span>
                  <EyeOutlined style={{ fontSize: 12, color: '#ff4d4f' }} />
                </div>
              </div>
            </Card>
          </Col>
        </Row>

        <Table
          columns={resultColumns}
          dataSource={results}
          rowKey={(record, index) => index}
          pagination={{
            current: batchPagination.current,
            pageSize: batchPagination.pageSize,
            showSizeChanger: true,
            showQuickJumper: true,
            showTotal: (total) => `å…± ${total} æ¡è®°å½•`,
            onChange: (page, size) => {
              setBatchPagination({ current: page, pageSize: size || 20 });
            },
            onShowSizeChange: (current, size) => {
              setBatchPagination({ current: 1, pageSize: size });
            }
          }}
          scroll={{ y: 'calc(100vh - 520px)' }}
          style={{ flex: 1 }}
        />
      </Card>
    );
  };

  return (
    <div>
      <Tabs 
        defaultActiveKey="single"
        items={[
          {
            key: 'single',
            label: (
              <span>
                <ApiOutlined />
                å•æ¡æµ‹è¯•
              </span>
            ),
            children: (
          {/* æ¨¡å‹é€‰æ‹©å’Œé…ç½®åŒºåŸŸ */}
          <Card style={{ marginBottom: 16 }} size="small">
            <Row gutter={16} align="middle">
              <Col span={8}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <ThunderboltOutlined style={{ color: '#1890ff' }} />
                  <Text strong>æµ‹è¯•æ¨¡å‹:</Text>
                  <Select
                    value={selectedModel?.id}
                    onChange={(modelId) => {
                      const model = availableModels.find(m => m.id === modelId);
                      setSelectedModel(model);
                    }}
                    style={{ minWidth: 200 }}
                    placeholder="é€‰æ‹©æµ‹è¯•æ¨¡å‹"
                  >
                    {availableModels.map(model => (
                      <Option key={model.id} value={model.id}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <span>{model.version}</span>
                          {model.is_active && <Tag size="small" color="green">æ¿€æ´»</Tag>}
                        </div>
                      </Option>
                    ))}
                  </Select>
                </div>
              </Col>
              <Col span={8}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <ExperimentOutlined style={{ color: '#52c41a' }} />
                  <Text strong>ç½®ä¿¡åº¦é˜ˆå€¼:</Text>
                  <Slider
                    min={0}
                    max={1}
                    step={0.1}
                    value={globalConfig.confidenceThreshold}
                    onChange={(value) => setGlobalConfig(prev => ({ ...prev, confidenceThreshold: value }))}
                    style={{ width: 120 }}
                    tooltip={{ formatter: (value) => `${Math.round(value * 100)}%` }}
                  />
                  <Text type="secondary" style={{ fontSize: 12 }}>
                    {Math.round(globalConfig.confidenceThreshold * 100)}%
                  </Text>
                </div>
              </Col>
              <Col span={8}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 12, justifyContent: 'flex-end' }}>
                  <Button 
                    icon={<SettingOutlined />}
                    onClick={() => setConfigModalVisible(true)}
                    size="small"
                  >
                    é«˜çº§é…ç½®
                  </Button>
                  <Button 
                    icon={<ApiOutlined />}
                    onClick={loadAvailableModels}
                    size="small"
                    type="text"
                  >
                    åˆ·æ–°æ¨¡å‹
                  </Button>
                </div>
              </Col>
            </Row>
          </Card>

          <Row gutter={24} style={{ height: 'calc(100vh - 280px)' }}>
            {/* å·¦ä¾§å¯¹è¯åŒº */}
            <Col span={16}>
              <Card 
                title="è¯­ä¹‰ç†è§£æµ‹è¯•" 
                style={{ height: '100%', display: 'flex', flexDirection: 'column' }}
                extra={
                  <Button size="small" onClick={clearHistory}>
                    æ¸…ç©ºå¯¹è¯
                  </Button>
                }
              >
                <div 
                  ref={chatHistoryRef}
                  style={{ 
                    flex: 1, 
                    overflowY: 'auto', 
                    padding: '24px 16px 0 16px',
                    marginBottom: 16,
                    border: '1px solid #f0f0f0',
                    borderRadius: 6,
                    backgroundColor: '#fafafa',
                    maxHeight: '500px',
                    scrollBehavior: 'smooth' // æ·»åŠ å¹³æ»‘æ»šåŠ¨æ•ˆæœ
                  }}
                >
                  {testHistory.length === 0 ? (
                    <div style={{ 
                      textAlign: 'center', 
                      padding: 40, 
                      color: '#999' 
                    }}>
                      å¼€å§‹æµ‹è¯•å¯¹è¯å§ï¼è¾“å…¥æ–‡æœ¬æŸ¥çœ‹AIç†è§£ç»“æœ
                    </div>
                  ) : (
                    testHistory.map(renderMessage)
                  )}
                </div>
                
                <div style={{ display: 'flex', gap: 8 }}>
                  <Input
                    value={testText}
                    onChange={(e) => setTestText(e.target.value)}
                    placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬..."
                    onPressEnter={handleSingleTest}
                    disabled={testing}
                  />
                  <Button 
                    type="primary" 
                    icon={<SendOutlined />}
                    onClick={handleSingleTest}
                    loading={testing}
                  >
                    å‘é€
                  </Button>
                </div>
              </Card>
            </Col>

            {/* å³ä¾§åŸå§‹å“åº” */}
            <Col span={8}>
              <Card 
                title="åŸå§‹å“åº”" 
                style={{ height: '100%' }}
                extra={
                  latestRawResponse && (
                    <Text type="secondary" style={{ fontSize: 12 }}>
                      {/* æ˜¾ç¤ºæœ€æ–°æµ‹è¯•çš„æ—¶é—´ï¼Œæ ¼å¼ï¼šå¹´æœˆæ—¥ æ—¶åˆ†ç§’ */}
                      {testHistory.length > 0 && testHistory[testHistory.length - 1].timestamp 
                        ? testHistory[testHistory.length - 1].timestamp.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                          })
                        : new Date().toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                          })}
                    </Text>
                  )
                }
              >
                {latestRawResponse ? (
                  <div>
                    <div style={{ marginBottom: 16 }}>
                      <Text strong>ç½®ä¿¡åº¦æœ€é«˜çš„å‰ä¸¤æ¡ï¼š</Text>
                    </div>
                    
                    {/* æ˜¾ç¤ºå‰ä¸¤ä¸ªæœ€é«˜ç½®ä¿¡åº¦çš„æ„å›¾ */}
                    {latestRawResponse.intent_ranking && latestRawResponse.intent_ranking.slice(0, 2).map((intent, index) => (
                      <div key={index} style={{ 
                        marginBottom: 12, 
                        padding: 12,
                        border: '1px solid #f0f0f0',
                        borderRadius: 6,
                        backgroundColor: index === 0 ? '#f6ffed' : '#fafafa'
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <Text strong>{intent.name}</Text>
                          <Tag color={index === 0 ? 'green' : 'default'}>
                            {Math.round(intent.confidence * 100)}%
                          </Tag>
                        </div>
                      </div>
                    ))}

                    <Divider />
                    
                    <Collapse 
                      size="small" 
                      defaultActiveKey={['full']}
                      items={[{
                        key: 'full',
                        label: 'å®Œæ•´åŸå§‹å“åº”',
                        children: (
                          <pre style={{ 
                            fontSize: 11,
                            backgroundColor: '#fafafa',
                            padding: 12,
                            borderRadius: 4,
                            maxHeight: 300,
                            overflow: 'auto'
                          }}>
                            {JSON.stringify(latestRawResponse, null, 2)}
                          </pre>
                        )
                      }]}
                    />
                  </div>
                ) : (
                  <div style={{ 
                    textAlign: 'center', 
                    padding: 40, 
                    color: '#999' 
                  }}>
                    <ApiOutlined style={{ fontSize: 48, marginBottom: 16 }} />
                    <div>è¿›è¡Œæµ‹è¯•åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºè¯¦ç»†çš„å“åº”ä¿¡æ¯</div>
                  </div>
                )}
              </Card>
            </Col>
          </Row>
            )
          },
          {
            key: 'batch',
            label: (
              <span>
                <BarChartOutlined />
                æ‰¹é‡æµ‹è¯•
              </span>
            ),
            children: (
              <div style={{ height: 'calc(100vh - 280px)' }}>
                <Card 
                  style={{ 
                    height: '100%', 
                    display: 'flex', 
                    flexDirection: 'column' 
                  }}
                  styles={{ 
                    body: {
                      flex: 1, 
                      display: 'flex', 
                      flexDirection: 'column',
                      padding: '24px'
                    }
                  }}
                >
                  <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <Title level={4} style={{ margin: 0 }}>æ‰¹é‡æµ‹è¯•</Title>
                    <Button 
                      type="primary" 
                      icon={<SettingOutlined />}
                      onClick={showBatchTestModal}
                      size="large"
                    >
                      å¼€å§‹æ‰¹é‡æµ‹è¯•
                    </Button>
                  </div>

                  {batchTestData.length > 0 && (
                    <Alert
                      message={`å·²åŠ è½½ ${batchTestData.length} æ¡æµ‹è¯•æ•°æ®`}
                      type="success"
                      style={{ marginBottom: 16 }}
                      showIcon
                    />
                  )}

                  <div style={{ flex: 1, overflow: 'hidden' }}>
                    {renderBatchTestResult()}
                  </div>
                </Card>
              </div>
            )
          }
        ]}
      />

      {/* é«˜çº§é…ç½®å¼¹çª— */}
      <Modal
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <SettingOutlined style={{ color: '#1890ff' }} />
            <span style={{ fontSize: 18, fontWeight: 600 }}>æµ‹è¯•é…ç½®</span>
          </div>
        }
        open={configModalVisible}
        onCancel={() => setConfigModalVisible(false)}
        footer={null}
        width={600}
        centered
      >
        <div style={{ padding: '20px 0' }}>
          <Form
            layout="vertical"
            initialValues={globalConfig}
            onFinish={(values) => {
              setGlobalConfig(values);
              setConfigModalVisible(false);
              message.success('é…ç½®å·²ä¿å­˜');
            }}
          >
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: 20, 
              borderRadius: 12, 
              marginBottom: 24,
              border: '1px solid #e9ecef'
            }}>
              <Title level={5} style={{ marginBottom: 16, color: '#495057' }}>
                è¯†åˆ«é˜ˆå€¼é…ç½®
              </Title>
              
              <Form.Item
                name="confidenceThreshold"
                label="ç½®ä¿¡åº¦é˜ˆå€¼"
                help="ä½äºæ­¤é˜ˆå€¼çš„é¢„æµ‹å°†è¢«è§†ä¸ºæœªè¯†åˆ«"
              >
                <Slider
                  min={0}
                  max={1}
                  step={0.05}
                  marks={{
                    0: '0%',
                    0.3: '30%',
                    0.5: '50%',
                    0.7: '70%',
                    1: '100%'
                  }}
                  tooltip={{ formatter: (value) => `${Math.round(value * 100)}%` }}
                />
              </Form.Item>
            </div>

            <div style={{ 
              backgroundColor: '#f0f8ff', 
              padding: 20, 
              borderRadius: 12, 
              marginBottom: 24,
              border: '1px solid #91d5ff'
            }}>
              <Title level={5} style={{ marginBottom: 16, color: '#1890ff' }}>
                æ˜¾ç¤ºé€‰é¡¹
              </Title>
              
              <Form.Item
                name="showAdvanced"
                valuePropName="checked"
                label="æ˜¾ç¤ºé«˜çº§ä¿¡æ¯"
                help="åœ¨æµ‹è¯•ç»“æœä¸­æ˜¾ç¤ºæ›´å¤šæŠ€æœ¯ç»†èŠ‚"
              >
                <Switch />
              </Form.Item>
            </div>

            <div style={{ textAlign: 'right' }}>
              <Space>
                <Button onClick={() => setConfigModalVisible(false)}>
                  å–æ¶ˆ
                </Button>
                <Button type="primary" htmlType="submit">
                  ä¿å­˜é…ç½®
                </Button>
              </Space>
            </div>
          </Form>
        </div>
      </Modal>

      {/* æ‰¹é‡æµ‹è¯•é…ç½®å¼¹çª— */}
      <Modal
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <SettingOutlined style={{ color: '#1890ff' }} />
            <span style={{ fontSize: 18, fontWeight: 600 }}>æ‰¹é‡æµ‹è¯•é…ç½®</span>
          </div>
        }
        open={batchModalVisible}
        onCancel={() => setBatchModalVisible(false)}
        footer={null}
        width={800}
        centered
      >
        <div style={{ padding: '20px 0' }}>
          <Form
            layout="vertical"
            onFinish={handleBatchTest}
          >
            {/* æµ‹è¯•é…ç½®åŒºåŸŸ - ç®€åŒ–ç‰ˆ */}
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: 20, 
              borderRadius: 12, 
              marginBottom: 24,
              border: '1px solid #e9ecef'
            }}>
              <Title level={5} style={{ marginBottom: 16, color: '#495057' }}>
                æµ‹è¯•é…ç½®
              </Title>
              
              <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                <Text strong>ç½®ä¿¡åº¦é˜ˆå€¼:</Text>
                <Slider
                  min={0}
                  max={1}
                  step={0.1}
                  value={globalConfig.confidenceThreshold}
                  onChange={(value) => setGlobalConfig(prev => ({ ...prev, confidenceThreshold: value }))}
                  style={{ width: 200 }}
                  tooltip={{ formatter: (value) => `${Math.round(value * 100)}%` }}
                />
                <Text type="secondary">
                  {Math.round(globalConfig.confidenceThreshold * 100)}%
                </Text>
              </div>
              <Text type="secondary" style={{ fontSize: 12, marginTop: 8, display: 'block' }}>
                ä½äºæ­¤é˜ˆå€¼çš„æ„å›¾è¯†åˆ«å°†è¢«è§†ä¸º"æœªè¯†åˆ«"
              </Text>
            </div>

            {/* æ•°æ®ä¸Šä¼ åŒºåŸŸ */}
            <div style={{ 
              backgroundColor: '#f0f8ff', 
              padding: 20, 
              borderRadius: 12, 
              marginBottom: 24,
              border: '1px solid #91d5ff'
            }}>
              <Title level={5} style={{ marginBottom: 16, color: '#1890ff' }}>
                æµ‹è¯•æ•°æ®ä¸Šä¼ 
              </Title>
              
              <div style={{ display: 'flex', alignItems: 'center', gap: 16, marginBottom: 16 }}>
                <Upload
                  accept=".csv,.json,.txt"
                  beforeUpload={handleFileUpload}
                  showUploadList={false}
                >
                  <Button 
                    icon={<UploadOutlined />}
                    size="large"
                    style={{
                      height: 60,
                      width: 200,
                      borderRadius: 8,
                      fontSize: 16,
                      fontWeight: 600,
                      background: 'linear-gradient(45deg, #40a9ff 0%, #1890ff 100%)',
                      border: 'none',
                      color: 'white',
                      boxShadow: '0 4px 12px rgba(24, 144, 255, 0.3)'
                    }}
                  >
                    é€‰æ‹©æµ‹è¯•æ–‡ä»¶
                  </Button>
                </Upload>
                
                <Dropdown
                  menu={{
                    items: [
                      {
                        key: 'csv',
                        label: 'CSV æ ¼å¼æ¨¡æ¿',
                        icon: <FileTextOutlined />,
                        onClick: () => downloadTemplate('csv')
                      },
                      {
                        key: 'txt',
                        label: 'TXT æ ¼å¼æ¨¡æ¿', 
                        icon: <FileTextOutlined />,
                        onClick: () => downloadTemplate('txt')
                      },
                      {
                        key: 'json',
                        label: 'JSON æ ¼å¼æ¨¡æ¿',
                        icon: <CodeOutlined />,
                        onClick: () => downloadTemplate('json')
                      }
                    ]
                  }}
                  placement="bottomLeft"
                  trigger={['click']}
                >
                  <Button 
                    icon={<DownloadOutlined />}
                    style={{
                      height: 48,
                      borderRadius: 6,
                      color: '#1890ff',
                      borderColor: '#1890ff'
                    }}
                  >
                    ä¸‹è½½æ¨¡æ¿ <span style={{ marginLeft: 4, fontSize: 12 }}>â–¼</span>
                  </Button>
                </Dropdown>
              </div>

              <div>
                <Text type="secondary" style={{ fontSize: 13, display: 'block', marginBottom: 8 }}>
                  æ”¯æŒ CSVã€TXT å’Œ JSON æ ¼å¼ã€‚CSV/TXTï¼šæ¯è¡Œä¸€ä¸ªæµ‹è¯•æ–‡æœ¬ï¼›JSONï¼š["æ–‡æœ¬1", "æ–‡æœ¬2"] æ ¼å¼
                </Text>
                <Text type="secondary" style={{ fontSize: 12, color: '#fa8c16' }}>
                  ğŸ’¡ æç¤ºï¼šå¦‚æœå‡ºç°ä¹±ç ï¼Œè¯·å°†æ–‡ä»¶ä¿å­˜ä¸º UTF-8 ç¼–ç æ ¼å¼ï¼Œæˆ–ç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•ç¼–ç æ£€æµ‹
                </Text>
              </div>

              {batchTestData.length > 0 && (
                <Alert
                  message={`å·²æˆåŠŸåŠ è½½ ${batchTestData.length} æ¡æµ‹è¯•æ•°æ®`}
                  type="success"
                  style={{ marginTop: 16 }}
                  showIcon
                />
              )}
            </div>

            {/* æ“ä½œæŒ‰é’®åŒºåŸŸ */}
            <div style={{ textAlign: 'right', paddingTop: 16 }}>
              <Space size="large">
                <Button 
                  size="large"
                  onClick={() => setBatchModalVisible(false)}
                  style={{ 
                    borderRadius: 8,
                    padding: '8px 24px',
                    height: 48
                  }}
                >
                  å–æ¶ˆ
                </Button>
                <Button 
                  type="primary" 
                  htmlType="submit"
                  loading={batchTesting}
                  disabled={batchTestData.length === 0}
                  size="large"
                  style={{ 
                    borderRadius: 8,
                    padding: '8px 32px',
                    height: 48,
                    fontSize: 16,
                    fontWeight: 600
                  }}
                >
                  å¼€å§‹æ‰¹é‡æµ‹è¯•
                </Button>
              </Space>
            </div>
          </Form>
        </div>
      </Modal>

      {/* åŸå§‹å“åº”å¼¹æ¡† */}
      <Modal
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <CodeOutlined style={{ color: '#1890ff' }} />
            <span style={{ fontSize: 16, fontWeight: 600 }}>åŸå§‹å“åº”æ•°æ®</span>
          </div>
        }
        open={rawResponseModalVisible}
        onCancel={() => setRawResponseModalVisible(false)}
        footer={[
          <Button 
            key="close" 
            onClick={() => setRawResponseModalVisible(false)}
            style={{ borderRadius: 6 }}
          >
            å…³é—­
          </Button>
        ]}
        width={800}
        centered
        maskClosable={true}
      >
        <div style={{ 
          maxHeight: 500, 
          overflow: 'auto',
          backgroundColor: '#f6f8fa',
          border: '1px solid #d0d7de',
          borderRadius: 8,
          padding: 16
        }}>
          <pre style={{ 
            margin: 0,
            fontSize: 12,
            lineHeight: 1.5,
            color: '#24292f',
            fontFamily: 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
            whiteSpace: 'pre-wrap',
            wordBreak: 'break-word'
          }}>
            {currentRawResponse ? JSON.stringify(currentRawResponse, null, 2) : 'æš‚æ— æ•°æ®'}
          </pre>
        </div>
      </Modal>

      {/* è¯¦æƒ…å¼¹çª— */}
      <Modal
        title={
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <EyeOutlined style={{ color: detailType === 'recognized' ? '#52c41a' : '#ff4d4f' }} />
            <span style={{ fontSize: 16, fontWeight: 600 }}>
              {detailType === 'recognized' ? 'æˆåŠŸè¯†åˆ«è¯¦æƒ…' : 'æœªè¯†åˆ«è¯¦æƒ…'}
            </span>
            <Tag color={detailType === 'recognized' ? 'success' : 'error'}>
              {detailData.length} æ¡è®°å½•
            </Tag>
          </div>
        }
        open={detailModalVisible}
        onCancel={() => setDetailModalVisible(false)}
        footer={[
          <Button 
            key="close" 
            onClick={() => setDetailModalVisible(false)}
            style={{ borderRadius: 6 }}
          >
            å…³é—­
          </Button>
        ]}
        width={1000}
        centered
        maskClosable={true}
      >
        <div style={{ maxHeight: 600, overflow: 'hidden' }}>
          <Table
            columns={[
              {
                title: 'åºå·',
                key: 'index',
                width: 60,
                render: (text, record, index) => index + 1,
              },
              {
                title: 'æµ‹è¯•æ–‡æœ¬',
                dataIndex: 'text',
                key: 'text',
                ellipsis: true,
                width: '35%',
              },
              {
                title: 'è¯†åˆ«æ„å›¾',
                dataIndex: 'predicted_intent',
                key: 'predicted_intent',
                width: '25%',
                render: (text, record) => {
                  const isRecognized = text && 
                                       text !== 'nlu_fallback' && 
                                       text !== 'out_of_scope' &&
                                       record.confidence >= globalConfig.confidenceThreshold;
                  
                  return (
                    <Tag color={isRecognized ? 'success' : 'error'}>
                      {isRecognized ? text : 'æœªè¯†åˆ«'}
                    </Tag>
                  );
                }
              },
              {
                title: 'ç½®ä¿¡åº¦',
                dataIndex: 'confidence',
                key: 'confidence',
                width: '25%',
                render: (confidence) => {
                  const percent = Math.round((confidence || 0) * 100);
                  return (
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      <Progress 
                        percent={percent} 
                        size="small"
                        status={confidence >= globalConfig.confidenceThreshold ? 'success' : 'exception'}
                        style={{ flex: 1 }}
                      />
                      <span style={{ 
                        fontSize: 12, 
                        color: confidence >= globalConfig.confidenceThreshold ? '#52c41a' : '#ff4d4f',
                        fontWeight: 500 
                      }}>
                        {percent}%
                      </span>
                    </div>
                  );
                }
              },
              {
                title: 'çŠ¶æ€',
                key: 'status',
                width: '15%',
                render: (text, record) => {
                  const isRecognized = record.predicted_intent && 
                                       record.predicted_intent !== 'nlu_fallback' && 
                                       record.predicted_intent !== 'out_of_scope' &&
                                       record.confidence >= globalConfig.confidenceThreshold;
                  
                  return (
                    <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                      {isRecognized ? (
                        <CheckCircleOutlined style={{ color: '#52c41a' }} />
                      ) : (
                        <CloseCircleOutlined style={{ color: '#ff4d4f' }} />
                      )}
                      <span style={{ 
                        fontSize: 12,
                        color: isRecognized ? '#52c41a' : '#ff4d4f',
                        fontWeight: 500
                      }}>
                        {isRecognized ? 'å·²è¯†åˆ«' : 'æœªè¯†åˆ«'}
                      </span>
                    </div>
                  );
                }
              }
            ]}
            dataSource={detailData}
            rowKey={(record, index) => index}
            pagination={{
              showSizeChanger: true,
              showQuickJumper: true,
              showTotal: (total) => `å…± ${total} æ¡è®°å½•`,
              pageSize: 10
            }}
            scroll={{ y: 450 }}
          />
        </div>
      </Modal>

      {/* æ‰¹é‡æµ‹è¯•loading */}
      <CustomLoading 
        visible={batchTesting} 
        text="æ­£åœ¨è¿›è¡Œæ‰¹é‡æµ‹è¯•" 
        description="æ­£åœ¨å¤„ç†æµ‹è¯•æ•°æ®ï¼Œè¯·ç¨å€™..."
        size="large"
      />
    </div>
  );
};

export default Testing;

