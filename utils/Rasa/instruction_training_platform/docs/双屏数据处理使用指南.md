# 双屏数据处理使用指南

## 📋 概述

双屏数据处理功能是智能对话训练平台的重要组成部分，专门用于处理双屏设备的指令和词槽Excel数据，并将其转换为RASA训练格式。

## 🎯 功能特点

### 1. 支持的数据格式
- **双屏指令Excel**: 包含指令标识、指令名称、分类、相似问、话术等
- **双屏词槽Excel**: 包含词槽名称、词槽描述、实体标准名、实体别名等
- **自动实体标注**: 支持 `[词槽名称]` 格式的实体标注解析

### 2. 输出格式
- **NLU训练文件**: 包含意图示例和实体标注
- **Domain配置文件**: 包含意图、实体、词槽、响应定义、表单定义
- **Rules规则文件**: 包含基本对话规则和表单处理规则
- **Stories故事文件**: 包含对话故事模板和词槽填充故事
- **Actions文件**: 包含自定义动作和追问逻辑
- **转换报告**: 详细的处理统计信息

## 📁 文件格式要求

### 双屏指令Excel格式
```
指令标识 | 指令名称 | 分类 | 相似问 | 指令描述 | 关联词槽 | 执行成功话术 | 执行失败话术 | 追问话术 | 追问失败话术
```

**示例**:
```
set_firepower | 设置火力 | COOKING | 设置[火力] | 设置烹饪火力 | 火力 | 火力设置成功 | 火力设置失败 | 请选择火力等级 | 火力设置错误
```

### 双屏词槽Excel格式
```
词槽名称 | 词槽描述 | 实体标准名 | 实体别名
```

**示例**:
```
火力 | 烹饪火力等级 | 高火 | 大火==最大火力==最高火力
```

### 实体标注规则
- 在相似问中使用 `[词槽名称]` 格式标注实体位置
- 系统会自动替换为实际实体值并生成RASA格式标注
- 支持多个实体标注在同一个相似问中

## 🚀 使用方法

### 1. API接口使用

#### 上传并处理双屏文件
```bash
POST /api/v2/dual-screen/upload-and-process
```

**参数**:
- `library_id`: 目标指令库ID
- `instruction_file`: 双屏指令Excel文件
- `slot_file`: 双屏词槽Excel文件

**响应**:
```json
{
  "success": true,
  "message": "双屏数据导入成功",
  "library_id": 1,
  "library_name": "双屏指令库",
  "import_statistics": {
    "instructions_imported": 41,
    "similar_questions_imported": 86,
    "slots_imported": 7,
    "slot_values_imported": 836
  },
  "rasa_files": {
    "nlu.yml": "rasa/data/library_1/nlu.yml",
    "domain.yml": "rasa/data/library_1/domain.yml",
    "rules.yml": "rasa/data/library_1/rules.yml",
    "stories.yml": "rasa/data/library_1/stories.yml"
  }
}
```

#### 从数据库生成RASA文件
```bash
POST /api/v2/dual-screen/generate-rasa-files/{library_id}
```

### 2. Python代码使用

```python
from backend.services.dual_screen_processor import process_dual_screen_files

# 处理双屏数据
instruction_file = "path/to/instruction.xlsx"
slot_file = "path/to/slot.xlsx"
output_dir = "rasa/data"

result = process_dual_screen_files(instruction_file, slot_file, output_dir)
print(f"处理完成，生成文件: {result}")
```

### 3. 直接使用处理器类

```python
from backend.services.dual_screen_processor import DualScreenProcessor

processor = DualScreenProcessor()

# 处理词槽数据
slots = processor.process_slot_data("slot_file.xlsx")

# 处理指令数据
instructions = processor.process_instruction_data("instruction_file.xlsx")

# 生成RASA文件
nlu_content = processor.generate_nlu_yml()
domain_content = processor.generate_domain_yml()
rules_content = processor.generate_rules_yml()
stories_content = processor.generate_stories_yml()
```

## 📊 处理统计信息

### 转换报告示例
```json
{
  "conversion_time": "2025-07-01T14:41:50.792198",
  "statistics": {
    "total_instructions": 41,
    "total_slots": 7,
    "instructions_by_category": {
      "COOKING": 18,
      "SYSTEM": 22,
      "RECIPES": 1
    },
    "slots_by_type": {
      "categorical": 7
    },
    "total_training_examples": 86,
    "total_entities": 836
  }
}
```

## 🔧 高级功能

### 1. 词槽名称英文映射
系统自动将中文词槽名称映射为英文：
- `火力` → `fire_power`
- `休眠时间` → `sleep_time`
- `菜品名称` → `dish_name`

### 2. 实体标注自动生成
对于包含 `[词槽名称]` 的相似问，系统会：
1. 查找对应词槽的所有实体值
2. 为每个实体值生成一个训练样本
3. 自动标注实体位置和类型

### 3. 同义词处理
系统支持实体别名处理：
- 实体别名用 `==` 分隔
- 自动生成RASA同义词配置

## ⚠️ 注意事项

### 1. 文件格式要求
- 必须是Excel格式 (.xlsx 或 .xls)
- 列名必须与格式要求一致
- 编码必须为UTF-8

### 2. 数据质量要求
- 指令标识必须唯一
- 词槽名称不能为空
- 实体标准名不能重复

### 3. 性能考虑
- 大量数据处理时可能需要较长时间
- 建议分批处理超大文件
- 内存使用量与数据量成正比

## 🐛 常见问题

### Q1: 处理失败怎么办？
**A**: 检查文件格式、列名、数据完整性，查看错误日志定位问题。

### Q2: 实体标注不正确？
**A**: 确保词槽文件中的词槽名称与指令文件中的标注一致。

### Q3: 生成的RASA文件有问题？
**A**: 检查转换报告，确认数据统计信息是否正确。

### Q4: 如何验证处理结果？
**A**: 查看生成的转换报告和RASA文件内容，确认数据完整性。

## 📈 最佳实践

### 1. 数据准备
- 确保Excel文件格式正确
- 验证数据完整性和一致性
- 检查词槽标注格式

### 2. 处理流程
- 先处理词槽文件再处理指令文件
- 及时检查处理结果
- 保存转换报告备查

### 3. 结果验证
- 检查生成的RASA文件语法
- 验证实体标注正确性
- 测试训练文件可用性

## 🔄 版本历史

### v1.0.0 (2025-07-01)
- 初始版本发布
- 支持双屏指令和词槽处理
- 生成完整RASA训练文件
- 提供详细转换报告

---

*本文档最后更新时间: 2025-07-01* 