# 追问逻辑实现详解

## 📋 概述

追问逻辑是智能对话系统中的核心功能，当用户输入的指令中词槽没有填充完毕时，系统需要主动追问缺失的信息。

## 🎯 追问场景

### 典型对话场景
```
用户: "设置火力"
机器人: "请选择您要设置的火力等级"  
用户: "高火"
机器人: "火力已设置为高火"
```

### 复杂追问场景
```
用户: "帮我把红烧萝卜烹一点"
机器人: "请告诉我您要设置的口感"
用户: "嫩一些"
机器人: "已为您设置好红烧萝卜的脆嫩口感"
```

## 🔧 RASA实现架构

### 1. 核心组件

#### Forms（表单）
- **作用**: 自动收集必需的词槽
- **配置**: 在domain.yml中定义
- **特点**: 自动循环直到所有必需词槽被填充

#### Custom Actions（自定义动作）
- **作用**: 处理词槽验证和追问逻辑
- **功能**: 验证用户输入、控制追问次数

### 2. 数据流程
```
用户输入 → NLU识别 → 激活表单 → 检查词槽 → 追问缺失词槽 → 验证输入 → 完成任务
```

## 📁 配置示例

### Domain.yml配置
```yaml
forms:
  set_firepower_form:
    required_slots:
      - fire_power

responses:
  utter_ask_fire_power:
    - text: "请选择您要设置的火力等级"
  
  utter_ask_fire_power_invalid:
    - text: "请选择正确的火力等级：低火、中火、高火、解冻或中高火"
```

### Actions.py自定义动作
```python
class ActionValidateForm(FormValidationAction):
    def validate_fire_power(self, slot_value, dispatcher, tracker, domain):
        valid_values = ["低火", "中火", "高火", "解冻", "中高火"]
        
        if slot_value and slot_value in valid_values:
            return {"fire_power": slot_value}
        else:
            dispatcher.utter_message(response="utter_ask_fire_power_invalid")
            return {"fire_power": None}
```

## 🚀 实现特性

### 1. 智能词槽检测
- 从关联词槽字段提取
- 从相似问标注中检测
- 自动识别必需词槽

### 2. 追问次数控制
- 可配置最大追问次数
- 超过次数自动退出
- 支持重新开始对话

### 3. 话术定制
- 支持自定义追问话术
- 支持失败重试话术
- 动态替换词槽名称

## 📊 双屏数据映射

| 双屏字段 | RASA组件 | 说明 |
|---------|----------|------|
| 追问话术 | utter_ask_{slot} | 词槽询问响应 |
| 追问失败话术 | utter_ask_{slot}_invalid | 验证失败响应 |
| 追问次数 | max_attempts | 最大尝试次数 |
| 关联词槽 | required_slots | 必需词槽列表 |

## 🎭 对话流程示例

### 单词槽追问
```
用户: "设置火力"
系统: 激活表单，检测到缺少fire_power词槽
系统: "请选择您要设置的火力等级"
用户: "高火"
系统: 验证成功，填充词槽
系统: "火力已设置为高火"
```

### 错误重试
```
用户: "设置火力"
系统: "请选择您要设置的火力等级"
用户: "很大的火"
系统: "请选择正确的火力等级：低火、中火、高火、解冻或中高火"
用户: "高火"
系统: "火力已设置为高火"
```

## 🎯 最佳实践

### 1. 词槽设计
- 明确定义必需词槽
- 提供完整的实体值列表
- 设计合理的同义词

### 2. 追问话术
- 简洁明了，便于用户理解
- 提供具体的选项或示例
- 区分首次追问和重试追问

### 3. 错误处理
- 限制追问次数避免死循环
- 提供清晰的错误提示
- 支持重新开始或退出

## 📝 总结

双屏数据处理器现在完全支持追问逻辑，通过以下方式实现：

1. **智能检测**: 自动识别必需词槽
2. **表单生成**: 自动创建RASA表单定义  
3. **追问控制**: 支持自定义追问次数和话术
4. **验证机制**: 完整的词槽验证和错误处理
5. **对话管理**: 生成完整的对话流程配置

这确保了当用户输入的指令中词槽没有填充完毕时，系统能够智能地进行追问，直到收集到所有必要信息。

---

*文档最后更新时间: 2025-07-01* 